<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–∞–±—ñ–Ω–µ—Ç —É—á–∞—Å–Ω–∏–∫–∞ ‚Äî –¢–µ–Ω–¥–µ—Ä 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@300;400;600;700&family=e-Ukraine:wght@300;400;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#f5f7fa;--surface:#ffffff;--surface2:#f0f2f5;--surface3:#e8ebef;
  --accent:#16a34a;--accent2:#22c55e;--accent-dim:rgba(22,163,74,.08);
  --gold:#d97706;--gold-dim:rgba(217,119,6,.06);
  --red:#dc2626;--red-dim:rgba(220,38,38,.06);
  --blue:#2563eb;--blue-dim:rgba(37,99,235,.06);
  --text:#1e293b;--text2:#475569;--text3:#94a3b8;
  --border:#e2e8f0;--border2:#cbd5e1;
  --radius:12px;
  --shadow:0 1px 3px rgba(0,0,0,.06),0 1px 2px rgba(0,0,0,.04);
  --shadow-lg:0 4px 16px rgba(0,0,0,.08);
}
body{font-family:'e-Ukraine',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:0 2rem;height:60px;display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;box-shadow:var(--shadow);
}
.header-left{display:flex;align-items:center;gap:1rem}
.header-logo{font-family:'Unbounded',sans-serif;font-weight:700;font-size:.95rem;color:var(--text)}
.header-logo span{color:var(--accent)}
.back-link{
  display:inline-flex;align-items:center;gap:.3rem;font-size:.78rem;
  color:var(--text3);text-decoration:none;padding:.3rem .7rem;
  border-radius:8px;border:1px solid var(--border);transition:all .2s;
}
.back-link:hover{border-color:var(--accent);color:var(--accent)}
.header-right{display:flex;align-items:center;gap:1rem}
.company-badge{
  font-size:.8rem;font-weight:600;color:var(--accent);
  background:var(--accent-dim);padding:.35rem .9rem;border-radius:100px;
}
.btn-logout{
  font-size:.72rem;color:var(--text3);cursor:pointer;background:none;border:1px solid var(--border);
  padding:.3rem .7rem;border-radius:8px;font-family:inherit;transition:all .2s;
}
.btn-logout:hover{border-color:var(--red);color:var(--red)}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
.nav{background:var(--surface);border-bottom:1px solid var(--border);padding:0 2rem;display:flex;gap:.3rem}
.nav-tab{
  padding:.8rem 1.2rem;font-size:.82rem;font-weight:600;color:var(--text3);
  cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;
  font-family:inherit;transition:all .2s;
}
.nav-tab:hover{color:var(--text2)}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{max-width:1100px;margin:0 auto;padding:1.5rem 2rem}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none}.screen.active{display:block}

/* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
.login-wrap{min-height:calc(100vh - 60px);display:flex;align-items:center;justify-content:center}
.login-box{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:2.5rem;width:100%;max-width:400px;box-shadow:var(--shadow-lg);text-align:center;
}
.login-box h2{font-family:'Unbounded',sans-serif;font-size:1.3rem;font-weight:700;margin-bottom:.5rem}
.login-box h2 span{color:var(--accent)}
.login-box p{color:var(--text2);font-size:.85rem;margin-bottom:1.5rem}
.login-input{
  width:100%;padding:.8rem 1rem;background:var(--surface2);border:1px solid var(--border);
  border-radius:var(--radius);color:var(--text);font-size:1.1rem;font-family:'JetBrains Mono',monospace;
  text-align:center;letter-spacing:3px;outline:none;transition:all .2s;
}
.login-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.login-btn{
  width:100%;padding:.8rem;margin-top:1rem;border-radius:var(--radius);
  background:var(--accent);color:#fff;font-size:.9rem;font-weight:600;
  border:none;cursor:pointer;font-family:inherit;transition:all .2s;
}
.login-btn:hover{background:#15803d;transform:translateY(-1px)}
.login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.login-hint{font-size:.72rem;color:var(--text3);margin-top:1rem}
.login-error{color:var(--red);font-size:.82rem;margin-top:.8rem;display:none}

/* ‚îÄ‚îÄ STATS BAR ‚îÄ‚îÄ */
.stats-bar{
  display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;
}
.stat-card{
  flex:1;min-width:140px;background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:1rem 1.2rem;box-shadow:var(--shadow);
}
.stat-card .num{font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--accent)}
.stat-card .label{font-size:.72rem;color:var(--text3);margin-top:.2rem}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:1.2rem 1.5rem;margin-bottom:.8rem;box-shadow:var(--shadow);transition:all .2s;
}
.card:hover{border-color:var(--accent);box-shadow:var(--shadow-lg)}
.card-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:.5rem}
.card-title{font-size:.9rem;font-weight:700}
.card-sub{font-size:.78rem;color:var(--text2);margin-top:.15rem}
.card-dr{font-size:.75rem;color:var(--text3);margin-bottom:.6rem}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{
  display:inline-flex;align-items:center;gap:.3rem;
  padding:.25rem .7rem;border-radius:100px;font-size:.7rem;font-weight:600;
}
.badge-green{background:rgba(22,163,74,.08);color:#16a34a}
.badge-yellow{background:rgba(234,179,8,.08);color:#b45309}
.badge-red{background:rgba(220,38,38,.08);color:#dc2626}
.badge-blue{background:rgba(37,99,235,.08);color:#2563eb}

/* ‚îÄ‚îÄ PRICES GRID ‚îÄ‚îÄ */
.prices{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;margin-top:.6rem;padding-top:.6rem;border-top:1px solid var(--border)}
.price-item{text-align:center}
.price-label{font-size:.65rem;color:var(--text3);text-transform:uppercase;letter-spacing:.3px}
.price-val{font-family:'JetBrains Mono',monospace;font-size:.95rem;font-weight:600;color:var(--accent);margin-top:.1rem}
.price-val.empty{color:var(--text3)}
.price-diff{font-size:.65rem;font-weight:600;margin-top:.15rem}
.price-diff.best{color:#16a34a}
.price-diff.equal{color:#16a34a}
.price-diff.close{color:#b45309}
.price-diff.far{color:#dc2626}
.price-diff.nodata{color:var(--text3);font-weight:400}
.card-actions{display:flex;gap:.5rem;margin-top:.8rem}

/* ‚îÄ‚îÄ LOTS GRID ‚îÄ‚îÄ */
.lots-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:.8rem}
.lot-card{cursor:default}
.lot-id{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--accent);font-weight:600}
.lot-name{font-size:.85rem;font-weight:600;margin:.2rem 0}
.lot-footer{display:flex;justify-content:space-between;align-items:center;margin-top:.6rem;padding-top:.6rem;border-top:1px solid var(--border)}
.lot-qty{font-size:.75rem;color:var(--text3)}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:.4rem;
  padding:.55rem 1.1rem;border-radius:var(--radius);font-size:.8rem;
  font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:all .2s;
}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:#15803d;transform:translateY(-1px)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-outline{background:transparent;color:var(--text2);border:1px solid var(--border)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-sm{padding:.4rem .8rem;font-size:.72rem}
.btn-full{width:100%}

/* ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ */
.search-box{position:relative;margin-bottom:1rem}
.search-box input{
  width:100%;padding:.7rem 1rem .7rem 2.4rem;background:var(--surface);
  border:1px solid var(--border);border-radius:var(--radius);font-size:.82rem;
  font-family:inherit;color:var(--text);outline:none;
}
.search-box input:focus{border-color:var(--accent)}
.search-box::before{content:'üîç';position:absolute;left:.8rem;top:50%;transform:translateY(-50%);font-size:.85rem}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;align-items:center;justify-content:center;z-index:1000;padding:1.5rem;
}
.modal-overlay.active{display:flex}
.modal{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:2rem;width:100%;max-width:500px;box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto;
}
.modal h3{font-family:'Unbounded',sans-serif;font-size:1rem;font-weight:700;margin-bottom:.3rem}
.modal .modal-sub{font-size:.8rem;color:var(--text2);margin-bottom:1.5rem}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-group{margin-bottom:1rem}
.form-label{display:block;font-size:.72rem;font-weight:600;color:var(--text2);margin-bottom:.3rem;text-transform:uppercase;letter-spacing:.3px}
.form-input{
  width:100%;padding:.65rem .9rem;background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:.85rem;font-family:inherit;outline:none;transition:all .2s;
}
.form-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.form-input::placeholder{color:var(--text3)}
textarea.form-input{resize:vertical;min-height:70px}
.form-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.8rem}
.form-hint{font-size:.68rem;color:var(--text3);margin-top:.3rem}
.modal-actions{display:flex;gap:.8rem;margin-top:1.5rem}
.modal-actions .btn{flex:1}

/* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
.section-title{
  font-family:'Unbounded',sans-serif;font-size:.95rem;font-weight:600;
  margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;
}
.section-title::before{content:'';width:3px;height:1em;background:var(--accent);border-radius:2px}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-container{position:fixed;top:72px;right:1.5rem;z-index:2000}
.toast{
  background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
  padding:.8rem 1.2rem;margin-bottom:.5rem;font-size:.82rem;min-width:260px;
  box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:.6rem;animation:slideIn .3s ease;
}
.toast.success{border-color:var(--accent)}
.toast.error{border-color:var(--red)}
@keyframes slideIn{from{opacity:0;transform:translateX(30px)}to{opacity:1;transform:none}}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:3rem 1.5rem}
.empty-state .icon{font-size:2.5rem;margin-bottom:.8rem;opacity:.4}
.empty-state p{color:var(--text2);font-size:.85rem}

/* ‚îÄ‚îÄ SPINNER ‚îÄ‚îÄ */
.spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-state{text-align:center;padding:3rem;color:var(--text2)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:640px){
  .main{padding:1rem}
  .header{padding:0 1rem}
  .nav{padding:0 1rem;overflow-x:auto}
  .nav-tab{padding:.8rem 1rem;white-space:nowrap}
  .form-row{grid-template-columns:1fr}
  .lots-grid{grid-template-columns:1fr}
  .modal{padding:1.5rem;margin:1rem}
  .stats-bar{gap:.6rem}
  .stat-card{min-width:100px;padding:.8rem}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<header class="header">
  <div class="header-left">
    <div class="header-logo">–¢–µ–Ω–¥–µ—Ä <span>2026</span></div>
    <a href="index.html" class="back-link">‚Üê –î–∞—à–±–æ—Ä–¥</a>
  </div>
  <div class="header-right" id="headerUser" style="display:none">
    <span class="company-badge" id="headerCompany"></span>
    <button class="btn-logout" onclick="logout()">–í–∏–π—Ç–∏</button>
  </div>
</header>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<nav class="nav" id="mainNav" style="display:none">
  <button class="nav-tab active" data-tab="offers" onclick="switchTab('offers')">üìä –ú–æ—ó –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</button>
  <button class="nav-tab" data-tab="lots" onclick="switchTab('lots')">üìã –ö–∞—Ç–∞–ª–æ–≥ –ª–æ—Ç—ñ–≤</button>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screenLogin">
  <div class="login-wrap">
    <div class="login-box">
      <h2>–ö–∞–±—ñ–Ω–µ—Ç <span>—É—á–∞—Å–Ω–∏–∫–∞</span></h2>
      <p>–í–≤–µ–¥—ñ—Ç—å –Ñ–î–†–ü–û–£ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è–º–∏</p>
      <input type="text" class="login-input" id="loginEdrpou" placeholder="00000000" maxlength="10"
             onkeypress="if(event.key==='Enter')doLogin()">
      <button class="login-btn" id="btnLogin" onclick="doLogin()">–£–≤—ñ–π—Ç–∏</button>
      <div class="login-error" id="loginError"></div>
      <p class="login-hint">–í–∞—à—ñ –¥–∞–Ω—ñ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ. –í–∏ –±–∞—á–∏—Ç–µ —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó.</p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MY OFFERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenOffers">
  <div class="main">
    <div class="stats-bar" id="statsBar"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <div class="section-title" style="margin-bottom:0">–ú–æ—ó –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—ó</div>
      <button class="btn btn-outline btn-sm" onclick="loadMyOffers()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
    </div>
    <div id="offersContainer"><div class="loading-state"><div class="spinner"></div></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screenLots">
  <div class="main">
    <div class="section-title">–ö–∞—Ç–∞–ª–æ–≥ –ª–æ—Ç—ñ–≤</div>
    <div class="search-box">
      <input type="text" id="lotsSearch" placeholder="–ü–æ—à—É–∫ –∑–∞ –Ω–∞–∑–≤–æ—é –∞–±–æ –î–†..." oninput="filterLots()">
    </div>
    <div class="lots-grid" id="lotsGrid"><div class="loading-state"><div class="spinner"></div></div></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modalOffer">
  <div class="modal">
    <h3 id="modalTitle">–ù–æ–≤–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è</h3>
    <p class="modal-sub" id="modalSub"></p>
    <input type="hidden" id="offerLotId">
    <input type="hidden" id="offerEditId">

    <div class="form-group">
      <label class="form-label">–ù–∞–∑–≤–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É *</label>
      <input type="text" class="form-input" id="offerProduct" placeholder="–ù–∞–∑–≤–∞ –≤–∞—à–æ–≥–æ –ø—Ä–µ–ø–∞—Ä–∞—Ç—É">
    </div>
    <div class="form-group">
      <label class="form-label">–î—ñ—é—á–∞ —Ä–µ—á–æ–≤–∏–Ω–∞</label>
      <input type="text" class="form-input" id="offerIngredient" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –¢—ñ–∞–∫–ª–æ–ø—Ä–∏–¥ ‚Äî 240 –≥/–ª">
      <p class="form-hint" id="offerDRHint"></p>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, $</label>
        <input type="text" class="form-input" id="offerPricePre" placeholder="0.00" oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
      </div>
      <div class="form-group">
        <label class="form-label">20/80, $</label>
        <input type="text" class="form-input" id="offerPrice2080" placeholder="0.00" oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä—Ç–Ω–µ—Ä—Å—å–∫–∞, $</label>
        <input type="text" class="form-input" id="offerPriceEasy" placeholder="0.00" oninput="this.value=this.value.replace(/[^0-9.,]/g,'')">
      </div>
    </div>
    <p class="form-hint">–¶—ñ–Ω–∏ –∑ –ü–î–í —É –¥–æ–ª–∞—Ä–∞—Ö. –í–∫–∞–∂—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É —Ü—ñ–Ω—É.</p>
    <div class="form-group">
      <label class="form-label">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
      <textarea class="form-input" id="offerComment" placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn btn-primary" id="btnSubmit" onclick="submitOffer()">–ü–æ–¥–∞—Ç–∏</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
// ============================================================================
// CONFIG ‚Äî –ó–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ URL –≤–∞—à–æ–≥–æ WebApp
// ============================================================================
var API_URL = 'YOUR_WEBAPP_URL_HERE';

var session = { token:null, company_id:null, company_name:null, lots:[], offers:[] };

// ============================================================================
// AUTH
// ============================================================================
function doLogin() {
  var edrpou = document.getElementById('loginEdrpou').value.trim();
  if (!edrpou || edrpou.length < 6) { showError('–í–≤–µ–¥—ñ—Ç—å –∫–æ—Ä–µ–∫—Ç–Ω–∏–π –Ñ–î–†–ü–û–£'); return; }

  var btn = document.getElementById('btnLogin');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';

  apiCall('auth', {edrpou:edrpou}, function(data) {
    btn.disabled = false; btn.textContent = '–£–≤—ñ–π—Ç–∏';
    if (!data.ok) { showError(data.error || '–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó'); return; }
    session.token = data.token;
    session.company_id = data.company_id;
    session.company_name = data.company_name;
    try { sessionStorage.setItem('cabinet_session', JSON.stringify(session)); } catch(e){}
    enterApp();
  });
}

function showError(msg) {
  var el = document.getElementById('loginError');
  el.textContent = msg; el.style.display = 'block';
}

function logout() {
  session = {token:null,company_id:null,company_name:null,lots:[],offers:[]};
  try { sessionStorage.removeItem('cabinet_session'); } catch(e){}
  document.getElementById('screenLogin').classList.add('active');
  document.getElementById('screenOffers').classList.remove('active');
  document.getElementById('screenLots').classList.remove('active');
  document.getElementById('mainNav').style.display = 'none';
  document.getElementById('headerUser').style.display = 'none';
  document.getElementById('loginEdrpou').value = '';
  document.getElementById('loginError').style.display = 'none';
}

function enterApp() {
  document.getElementById('headerCompany').textContent = session.company_name;
  document.getElementById('headerUser').style.display = 'flex';
  document.getElementById('mainNav').style.display = 'flex';
  document.getElementById('screenLogin').classList.remove('active');
  switchTab('offers');
  loadLots();
  loadMyOffers();
}

// Auto-restore + URL param
(function(){
  var urlEdrpou = new URLSearchParams(window.location.search).get('edrpou');
  if (urlEdrpou) {
    document.getElementById('loginEdrpou').value = urlEdrpou;
    doLogin();
    return;
  }
  try {
    var saved = sessionStorage.getItem('cabinet_session');
    if (saved) { var s = JSON.parse(saved); if(s&&s.token){session=s;enterApp();} }
  } catch(e){}
})();

// ============================================================================
// NAVIGATION
// ============================================================================
function switchTab(tab) {
  document.querySelectorAll('.nav-tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active')});
  if (tab==='lots') {
    document.getElementById('screenLots').classList.add('active');
    if(!session.lots.length) loadLots();
  } else {
    document.getElementById('screenOffers').classList.add('active');
  }
}

// ============================================================================
// LOTS
// ============================================================================
function loadLots() {
  var g = document.getElementById('lotsGrid');
  g.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  apiCall('lots', {}, function(data){
    if(!data.ok){g.innerHTML='<div class="empty-state"><p>'+(data.error||'–ü–æ–º–∏–ª–∫–∞')+'</p></div>';return;}
    session.lots = data.lots;
    renderLots(data.lots);
  });
}

function renderLots(lots) {
  var g = document.getElementById('lotsGrid');
  if(!lots||!lots.length){g.innerHTML='<div class="empty-state"><div class="icon">üìã</div><p>–õ–æ—Ç–∏ —â–µ –Ω–µ –¥–æ–¥–∞–Ω—ñ</p></div>';return;}
  g.innerHTML = lots.map(function(l){
    return '<div class="card lot-card" data-search="'+esc(l.name+' '+l.active_ingredient).toLowerCase()+'">'
      +'<div class="lot-id">–õ–û–¢ #'+esc(l.lot_id)+'</div>'
      +'<div class="lot-name">'+esc(l.name)+'</div>'
      +(l.active_ingredient?'<div class="card-dr">üß™ '+esc(l.active_ingredient)+'</div>':'')
      +'<div class="lot-footer"><span class="lot-qty">üìä '+esc(l.quantity)+' '+esc(l.unit)+'</span>'
      +'<button class="btn btn-primary btn-sm" onclick="openNewOffer(\''+esc(l.lot_id)+'\')">üìù –ü–æ–¥–∞—Ç–∏</button></div>'
      +'</div>';
  }).join('');
}

function filterLots(){
  var q=document.getElementById('lotsSearch').value.toLowerCase();
  document.querySelectorAll('.lot-card').forEach(function(c){
    c.style.display=(c.dataset.search||'').indexOf(q)!==-1?'':'none';
  });
}

// ============================================================================
// MY OFFERS
// ============================================================================
function loadMyOffers() {
  var c = document.getElementById('offersContainer');
  c.innerHTML = '<div class="loading-state"><div class="spinner"></div></div>';
  apiCall('my_offers', {}, function(data){
    if(!data.ok){c.innerHTML='<div class="empty-state"><p>'+(data.error||'–ü–æ–º–∏–ª–∫–∞')+'</p></div>';return;}
    session.offers = data.offers;
    renderStats(data.offers);
    renderOffers(data.offers);
  });
}

function renderStats(offers) {
  var total = offers.length;
  var approved = offers.filter(function(o){return o.status==='–ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ'}).length;
  var pending = offers.filter(function(o){return o.status==='–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ'}).length;
  var rejected = offers.filter(function(o){return o.status==='–í—ñ–¥—Ö–∏–ª–µ–Ω–æ'}).length;
  var lots = {};
  offers.forEach(function(o){lots[o.lot_id]=true});
  var lotCount = Object.keys(lots).length;

  document.getElementById('statsBar').innerHTML =
    '<div class="stat-card"><div class="num">'+total+'</div><div class="label">–ü—Ä–æ–ø–æ–∑–∏—Ü—ñ–π</div></div>'
    +'<div class="stat-card"><div class="num">'+lotCount+'</div><div class="label">–õ–æ—Ç—ñ–≤</div></div>'
    +'<div class="stat-card"><div class="num" style="color:#16a34a">'+approved+'</div><div class="label">–ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</div></div>'
    +'<div class="stat-card"><div class="num" style="color:#b45309">'+pending+'</div><div class="label">–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ</div></div>'
    +(rejected?'<div class="stat-card"><div class="num" style="color:#dc2626">'+rejected+'</div><div class="label">–í—ñ–¥—Ö–∏–ª–µ–Ω–æ</div></div>':'');
}

function renderOffers(offers) {
  var c = document.getElementById('offersContainer');
  if(!offers||!offers.length){
    c.innerHTML='<div class="empty-state"><div class="icon">üìä</div><p>–£ –≤–∞—Å —â–µ –Ω–µ–º–∞—î –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π</p>'
      +'<button class="btn btn-primary btn-sm" style="margin-top:1rem" onclick="switchTab(\'lots\')">üìã –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –ª–æ—Ç—ñ–≤</button></div>';
    return;
  }

  var lotMap = {}; session.lots.forEach(function(l){lotMap[l.lot_id]=l});

  c.innerHTML = offers.map(function(o){
    var lot = lotMap[o.lot_id]||{};
    var badge = '';
    var st = o.status||'';
    if(st==='–ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ') badge='<span class="badge badge-green">‚úÖ –ó–∞—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span>';
    else if(st==='–í—ñ–¥—Ö–∏–ª–µ–Ω–æ') badge='<span class="badge badge-red">‚ùå –í—ñ–¥—Ö–∏–ª–µ–Ω–æ</span>';
    else if(st==='–ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ') badge='<span class="badge badge-yellow">‚è≥ –ù–∞ —Ä–æ–∑–≥–ª—è–¥—ñ</span>';
    else badge='<span class="badge badge-blue">'+esc(st)+'</span>';

    return '<div class="card offer-card">'
      +'<div class="card-head"><div><div class="card-title">#'+esc(o.offer_id)+' ‚Äî '+esc(o.product_name)+'</div>'
      +'<div class="card-sub">–õ–æ—Ç #'+esc(o.lot_id)+': '+esc(lot.name||'')+'</div></div>'+badge+'</div>'
      +(o.active_ingredient?'<div class="card-dr">üß™ '+esc(o.active_ingredient)+'</div>':'')
      +(o.comment?'<div class="card-dr">üí¨ '+esc(o.comment)+'</div>':'')
      +'<div class="prices">'
      +priceCell('–ü–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞',o.price_prepayment,lot.min_pre)
      +priceCell('20/80',o.price_2080,lot.min_2080)
      +priceCell('–ü–∞—Ä—Ç–Ω–µ—Ä—Å—å–∫–∞',o.price_easy,lot.min_easy)
      +'</div>'
      +(st!=='–ê—Ä—Ö—ñ–≤'?'<div class="card-actions"><button class="btn btn-outline btn-sm" onclick="openEditOffer(\''+esc(o.offer_id)+'\')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button></div>':'')
      +'</div>';
  }).join('');
}

function priceCell(label,val,minPrice){
  var v = val?parseFloat(val).toFixed(2)+' $':'‚Äî';
  var diff = '';
  if (val && parseFloat(val) > 0) {
    var myP = parseFloat(val);
    if (minPrice && parseFloat(minPrice) > 0) {
      var minP = parseFloat(minPrice);
      if (Math.abs(myP - minP) < 0.005) {
        diff = '<div class="price-diff best">üèÜ –ù–∞–π–∫—Ä–∞—â–∞</div>';
      } else if (myP < minP) {
        diff = '<div class="price-diff best">üèÜ –ù–∞–π–∫—Ä–∞—â–∞</div>';
      } else {
        var pct = ((myP - minP) / minP * 100).toFixed(1);
        var cls = parseFloat(pct) <= 5 ? 'close' : 'far';
        diff = '<div class="price-diff '+cls+'">+'+pct+'% –≤—ñ–¥ –º—ñ–Ω.</div>';
      }
    } else {
      diff = '<div class="price-diff nodata">–Ω–µ–º–∞—î –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤</div>';
    }
  }
  return '<div class="price-item"><div class="price-label">'+label+'</div><div class="price-val'+(val?'':' empty')+'">'+v+'</div>'+diff+'</div>';
}

// ============================================================================
// MODAL
// ============================================================================
function openNewOffer(lotId) {
  var lot = session.lots.find(function(l){return l.lot_id===lotId});
  if(!lot) return;
  document.getElementById('modalTitle').textContent = '–ù–æ–≤–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è';
  document.getElementById('modalSub').textContent = '–õ–æ—Ç #'+lot.lot_id+': '+lot.name;
  document.getElementById('offerLotId').value = lotId;
  document.getElementById('offerEditId').value = '';
  document.getElementById('offerProduct').value = '';
  document.getElementById('offerIngredient').value = '';
  document.getElementById('offerPricePre').value = '';
  document.getElementById('offerPrice2080').value = '';
  document.getElementById('offerPriceEasy').value = '';
  document.getElementById('offerComment').value = '';
  document.getElementById('btnSubmit').textContent = '–ü–æ–¥–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é';
  document.getElementById('offerDRHint').textContent = lot.active_ingredient?'–í–∏–º–æ–≥–∞: '+lot.active_ingredient:'';
  document.getElementById('modalOffer').classList.add('active');
}

function openEditOffer(offerId) {
  var o = session.offers.find(function(x){return x.offer_id===offerId});
  if(!o) return;
  var lot = session.lots.find(function(l){return l.lot_id===o.lot_id})||{};
  document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ #'+offerId;
  document.getElementById('modalSub').textContent = '–õ–æ—Ç #'+o.lot_id+': '+(lot.name||'');
  document.getElementById('offerLotId').value = o.lot_id;
  document.getElementById('offerEditId').value = offerId;
  document.getElementById('offerProduct').value = o.product_name||'';
  document.getElementById('offerIngredient').value = o.active_ingredient||'';
  document.getElementById('offerPricePre').value = o.price_prepayment||'';
  document.getElementById('offerPrice2080').value = o.price_2080||'';
  document.getElementById('offerPriceEasy').value = o.price_easy||'';
  document.getElementById('offerComment').value = o.comment||'';
  document.getElementById('btnSubmit').textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏';
  document.getElementById('offerDRHint').textContent = lot.active_ingredient?'–í–∏–º–æ–≥–∞: '+lot.active_ingredient:'';
  document.getElementById('modalOffer').classList.add('active');
}

function closeModal(){document.getElementById('modalOffer').classList.remove('active')}

function submitOffer() {
  var editId = document.getElementById('offerEditId').value;
  var product = document.getElementById('offerProduct').value.trim();
  var ingredient = document.getElementById('offerIngredient').value.trim();
  var pp = document.getElementById('offerPricePre').value.trim();
  var p2 = document.getElementById('offerPrice2080').value.trim();
  var pe = document.getElementById('offerPriceEasy').value.trim();
  var comment = document.getElementById('offerComment').value.trim();

  if(!product){showToast('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –ø—Ä–µ–ø–∞—Ä–∞—Ç—É','error');return}
  if(!pp&&!p2&&!pe){showToast('–í–∫–∞–∂—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–Ω—É —Ü—ñ–Ω—É','error');return}

  var btn = document.getElementById('btnSubmit');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';

  var params = {product_name:product,active_ingredient:ingredient,price_prepayment:pp,price_2080:p2,price_easy:pe,comment:comment};

  if(editId) {
    params.offer_id = editId;
    apiCall('update_offer',params,function(data){
      btn.disabled=false; btn.textContent='–ó–±–µ—Ä–µ–≥—Ç–∏ –∑–º—ñ–Ω–∏';
      if(!data.ok){showToast(data.error||'–ü–æ–º–∏–ª–∫–∞','error');return}
      showToast(data.message||'–ó–±–µ—Ä–µ–∂–µ–Ω–æ!','success');
      closeModal(); loadMyOffers();
    });
  } else {
    params.lot_id = document.getElementById('offerLotId').value;
    apiCall('submit_offer',params,function(data){
      btn.disabled=false; btn.textContent='–ü–æ–¥–∞—Ç–∏ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é';
      if(!data.ok){showToast(data.error||'–ü–æ–º–∏–ª–∫–∞','error');return}
      showToast(data.message||'–ü–æ–¥–∞–Ω–æ!','success');
      closeModal(); loadMyOffers();
    });
  }
}

// ============================================================================
// API
// ============================================================================
function apiCall(action, params, callback) {
  params = params||{};
  params.action = action;
  if(session.token) params.token = session.token;

  var url = API_URL + '?' + encodeParams(params);

  fetch(url, {redirect:'follow'})
    .then(function(r){return r.json()})
    .then(function(data){
      if(data.error&&data.error.indexOf('–°–µ—Å—ñ—è')!==-1){logout();showToast('–°–µ—Å—ñ—è –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—å','error');return}
      callback(data);
    })
    .catch(function(){
      fetch(API_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify(params),redirect:'follow'})
        .then(function(r){return r.json()}).then(callback)
        .catch(function(){callback({ok:false,error:'–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è'})});
    });
}

function encodeParams(o){return Object.keys(o).map(function(k){return encodeURIComponent(k)+'='+encodeURIComponent(o[k])}).join('&')}

// ============================================================================
// UTILS
// ============================================================================
function showToast(msg,type){
  var c=document.getElementById('toasts');
  var t=document.createElement('div');
  t.className='toast '+(type||'');
  t.innerHTML=(type==='success'?'‚úÖ ':type==='error'?'‚ùå ':'‚ÑπÔ∏è ')+esc(msg);
  c.appendChild(t);
  setTimeout(function(){t.style.opacity='0';t.style.transition='.3s'},3000);
  setTimeout(function(){t.remove()},3500);
}

function esc(s){if(!s)return'';var d=document.createElement('div');d.textContent=String(s);return d.innerHTML}

document.getElementById('modalOffer').addEventListener('click',function(e){if(e.target===this)closeModal()});
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeModal()});
</script>
</body>
</html>
